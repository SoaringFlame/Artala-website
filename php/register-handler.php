<?php
session_start(); // Запускает сессию для сохранения данных пользователя во время его использования приложения
require 'database.php'; // Подключает файл для соединения с базой данных, который содержит информацию для PDO (PHP Data Objects)

// Проверка, была ли форма отправлена
if ($_SERVER["REQUEST_METHOD"] == "POST") { // Проверяет, был ли запрос выполнен методом POST, что указывает на отправку формы
    // Получение данных из формы
    $username = trim($_POST['username']); // Получает имя пользователя из формы и удаляет лишние пробелы по краям
    $email = trim($_POST['email']); // Получает адрес электронной почты из формы и удаляет лишние пробелы по краям
    $password = $_POST['password']; // Получает введённый пароль пользователя из формы

    // Проверка на пустые поля
    if (empty($username) || empty($email) || empty($password)) { // Если одно из полей пустое
        echo "Пожалуйста, заполните все поля."; // Выводит сообщение об ошибке
        exit; // Завершает выполнение скрипта
    }

    // Проверка корректности email
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) { // Проверяет, является ли введённый email корректным
        echo "Некорректный email."; // Выводит сообщение об ошибке, если email некорректный
        exit; // Завершает выполнение скрипта
    }

    // Хешируем пароль
    $hashed_password = password_hash($password, PASSWORD_DEFAULT); // Хеширует пароль для безопасного хранения в базе данных
    $token = bin2hex(random_bytes(16)); // Генерация уникального токена подтверждения для верификации email

    try {
        // Проверка на существование пользователя
        $stmtCheck = $pdo->prepare("SELECT * FROM users WHERE email = :email"); // Подготавливает SQL-запрос для проверки существования пользователя с указанным email
        $stmtCheck->execute(['email' => $email]); // Выполняет запрос, передавая email как параметр
        if ($stmtCheck->rowCount() > 0) { // Если количество найденных пользователей больше 0
            echo "Пользователь с таким email уже существует."; // Уведомление о том, что пользователь с таким email уже зарегистрирован
            exit; // Завершает выполнение скрипта
        }

        // Вставка пользователя в базу данных
        $stmt = $pdo->prepare("INSERT INTO users (username, email, password, token, email_verified) VALUES (:username, :email, :password, :token, 0)"); // Подготавливает SQL-запрос для вставки нового пользователя
        $stmt->execute([ // Выполняет запрос с переданными данными
            'username' => $username, // Передаёт имя пользователя
            'email' => $email, // Передаёт email
            'password' => $hashed_password, // Передаёт захэшированный пароль
            'token' => $token // Передаёт токен подтверждения
        ]);

        // Отправка письма с подтверждением
        $to = $email; // Получатель - введённый email
        $subject = "Подтверждение вашей учетной записи"; // Тема письма
        $message = "Пожалуйста, подтвердите свою учетную запись, перейдя по следующей ссылке:\n"; // Тело сообщения
        $message .= "http://ваш_домен/confirm.php?token=$token"; // Добавляет ссылку для подтверждения аккаунта с токеном
        $headers = "From: no-reply@ваш_домен"; // Устанавливает заголовок отправителя

        if (mail($to, $subject, $message, $headers)) { // Попытка отправить письмо
            echo "Проверьте вашу почту для подтверждения."; // Уведомление о том, что письмо отправлено успешно
        } else {
            echo "Ошибка при отправке письма."; // Сообщение об ошибке, если письмо не удалось отправить
        }
    } catch (PDOException $e) { // Обработка исключений при работе с базой данных
        echo "Ошибка базы данных: " . $e->getMessage(); // Выводит сообщение об ошибке, если возникает проблема с базой данных
        exit; // Завершает выполнение скрипта
    }
} else {
    echo "Неверный метод запроса."; // Сообщение, если форма была отправлена не методом POST
}
?>
